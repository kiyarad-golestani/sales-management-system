<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø¯ÛŒØ±ÛŒØª ØªÙˆØ±Ù‡Ø§ÛŒ ÙˆÛŒØ²ÛŒØª</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e1e1e1;
        }

        .header h1 {
            color: #333;
            font-size: 24px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-success {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
        }

        .btn-info {
            background: linear-gradient(45deg, #17a2b8, #138496);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(45deg, #ffc107, #e0a800);
            color: #333;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 1px solid #e1e1e1;
        }

        .tab {
            padding: 15px 25px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e1e1;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        th, td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid #e1e1e1;
        }

        th {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            font-weight: 500;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-printed {
            background: #fff3cd;
            color: #856404;
        }

        .status-completed {
            background: #d1ecf1;
            color: #0c5460;
        }

        .alert {
            padding: 12px;
            margin-bottom: 20px;
            border-radius: 8px;
            border: 1px solid transparent;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸšŒ Ù…Ø¯ÛŒØ±ÛŒØª ØªÙˆØ±Ù‡Ø§ÛŒ ÙˆÛŒØ²ÛŒØª</h1>
            <a href="{{ url_for('index') }}" class="btn btn-primary">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</a>
        </div>

        <div id="alert-container"></div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('periods')">Ø¯ÙˆØ±Ù‡â€ŒÙ‡Ø§ÛŒ ÙˆÛŒØ²ÛŒØª</button>
            <button class="tab" onclick="showTab('tours')">ØªÙˆØ±Ù‡Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯Ù‡</button>
            <button class="tab" onclick="showTab('execution')">Ø§Ø¬Ø±Ø§ÛŒ ØªÙˆØ±Ù‡Ø§</button>
            <button class="tab" onclick="showTab('reports')">Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§</button>
        </div>

        <!-- ØªØ¨ Ø¯ÙˆØ±Ù‡â€ŒÙ‡Ø§ÛŒ ÙˆÛŒØ²ÛŒØª -->
        <div id="periods-tab" class="tab-content active">
            <h3>Ø§ÛŒØ¬Ø§Ø¯ Ø¯ÙˆØ±Ù‡ ÙˆÛŒØ²ÛŒØª Ø¬Ø¯ÛŒØ¯</h3>
            <form id="period-form" class="form-grid">
                <div class="form-group">
                    <label for="period-name">Ù†Ø§Ù… Ø¯ÙˆØ±Ù‡:</label>
                    <input type="text" id="period-name" placeholder="Ù…Ø«Ø§Ù„: Ø¯ÙˆØ±Ù‡ Ø§ÙˆÙ„ Ø²Ù…Ø³ØªØ§Ù† 1403" required>
                </div>
                <div class="form-group">
                    <label for="start-date">ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹ (Ø´Ù…Ø³ÛŒ):</label>
                    <input type="text" id="start-date" placeholder="1403/01/01" required>
                </div>
                <div class="form-group">
                    <label for="end-date">ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù† (Ø´Ù…Ø³ÛŒ):</label>
                    <input type="text" id="end-date" placeholder="1403/01/07" required>
                </div>
                <div class="form-group">
                    <label for="total-tours">ØªØ¹Ø¯Ø§Ø¯ ØªÙˆØ±Ù‡Ø§:</label>
                    <select id="total-tours" required>
                        <option value="4">4 ØªÙˆØ±</option>
                        <option value="5">5 ØªÙˆØ±</option>
                    </select>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-success">Ø§ÛŒØ¬Ø§Ø¯ Ø¯ÙˆØ±Ù‡</button>
                </div>
            </form>

            <div class="table-container">
                <h3>Ø¯ÙˆØ±Ù‡â€ŒÙ‡Ø§ÛŒ ÙˆÛŒØ²ÛŒØª Ù…ÙˆØ¬ÙˆØ¯</h3>
                <table id="periods-table">
                    <thead>
                        <tr>
                            <th>Ú©Ø¯ Ø¯ÙˆØ±Ù‡</th>
                            <th>Ù†Ø§Ù… Ø¯ÙˆØ±Ù‡</th>
                            <th>ØªØ§Ø±ÛŒØ® Ø´Ø±ÙˆØ¹</th>
                            <th>ØªØ§Ø±ÛŒØ® Ù¾Ø§ÛŒØ§Ù†</th>
                            <th>ØªØ¹Ø¯Ø§Ø¯ ØªÙˆØ±Ù‡Ø§</th>
                            <th>ÙˆØ¶Ø¹ÛŒØª</th>
                            <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="7" class="loading">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ØªØ¨ ØªÙˆØ±Ù‡Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯Ù‡ -->
        <div id="tours-tab" class="tab-content">
            <h3>Ø§ÛŒØ¬Ø§Ø¯ ØªÙˆØ±Ù‡Ø§ Ø¨Ø±Ø§ÛŒ Ø¯ÙˆØ±Ù‡</h3>
            <form id="tours-form" class="form-grid">
                <div class="form-group">
                    <label for="select-period">Ø§Ù†ØªØ®Ø§Ø¨ Ø¯ÙˆØ±Ù‡:</label>
                    <select id="select-period" required>
                        <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="select-bazaryab">Ø§Ù†ØªØ®Ø§Ø¨ Ø¨Ø§Ø²Ø§Ø±ÛŒØ§Ø¨:</label>
                    <select id="select-bazaryab" required>
                        <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>
                    </select>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-success">Ø§ÛŒØ¬Ø§Ø¯ ØªÙˆØ±Ù‡Ø§</button>
                </div>
            </form>

            <div class="table-container">
                <h3>ØªÙˆØ±Ù‡Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯Ù‡</h3>
                <table id="tours-table">
                    <thead>
                        <tr>
                            <th>Ú©Ø¯ ØªÙˆØ±</th>
                            <th>Ø¯ÙˆØ±Ù‡</th>
                            <th>Ø´Ù…Ø§Ø±Ù‡ ØªÙˆØ±</th>
                            <th>ØªØ§Ø±ÛŒØ® ØªÙˆØ±</th>
                            <th>Ø¨Ø§Ø²Ø§Ø±ÛŒØ§Ø¨</th>
                            <th>ØªØ¹Ø¯Ø§Ø¯ Ù…Ø´ØªØ±ÛŒ</th>
                            <th>ÙˆØ¶Ø¹ÛŒØª</th>
                            <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="8" class="loading">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ØªØ¨ Ø§Ø¬Ø±Ø§ÛŒ ØªÙˆØ±Ù‡Ø§ -->
        <div id="execution-tab" class="tab-content">
            <h3>Ø«Ø¨Øª Ø§Ø¬Ø±Ø§ÛŒ ØªÙˆØ±</h3>
            <form id="execution-form" class="form-grid">
                <div class="form-group">
                    <label for="exec-tour">Ø§Ù†ØªØ®Ø§Ø¨ ØªÙˆØ±:</label>
                    <select id="exec-tour" required>
                        <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>
                    </select>
                </div>
            </form>

            <div id="tour-customers" style="display: none;">
                <h4>Ù„ÛŒØ³Øª Ù…Ø´ØªØ±ÛŒØ§Ù† ØªÙˆØ±</h4>
                <div id="customers-checklist"></div>
                <button id="save-execution" class="btn btn-success" style="margin-top: 20px;">Ø«Ø¨Øª ÙˆÛŒØ²ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡</button>
            </div>
        </div>

        <!-- ØªØ¨ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ -->
        <div id="reports-tab" class="tab-content">
            <h3>Ú¯Ø²Ø§Ø±Ø´ ÙˆÛŒØ²ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡</h3>
            <form id="reports-form" class="form-grid">
                <div class="form-group">
                    <label for="report-period">Ø§Ù†ØªØ®Ø§Ø¨ Ø¯ÙˆØ±Ù‡:</label>
                    <select id="report-period" required>
                        <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="report-bazaryab">Ø§Ù†ØªØ®Ø§Ø¨ Ø¨Ø§Ø²Ø§Ø±ÛŒØ§Ø¨:</label>
                    <select id="report-bazaryab">
                        <option value="">Ù‡Ù…Ù‡ Ø¨Ø§Ø²Ø§Ø±ÛŒØ§Ø¨Ø§Ù†</option>
                    </select>
                </div>
                <div class="form-group">
                    <button type="button" onclick="generateReport()" class="btn btn-info">ØªÙˆÙ„ÛŒØ¯ Ú¯Ø²Ø§Ø±Ø´</button>
                </div>
            </form>

            <div id="report-results" style="display: none;">
                <h4>Ù†ØªØ§ÛŒØ¬ Ú¯Ø²Ø§Ø±Ø´</h4>
                <div id="report-content"></div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let periods = [];
        let tours = [];
        let bazaryabs = [];

        // Tab management
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
            
            // Load data for active tab
            if (tabName === 'periods') {
                loadPeriods();
            } else if (tabName === 'tours') {
                loadToursData();
            } else if (tabName === 'execution') {
                loadExecutionData();
            } else if (tabName === 'reports') {
                loadReportsData();
            }
        }

        // Alert functions
        function showAlert(message, type = 'success') {
            const alertContainer = document.getElementById('alert-container');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            alertContainer.innerHTML = '';
            alertContainer.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // Load periods
        async function loadPeriods() {
            try {
                const response = await fetch('/get_visit_periods');
                const data = await response.json();
                
                if (data.periods) {
                    periods = data.periods;
                    renderPeriodsTable();
                    updatePeriodSelects();
                }
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯ÙˆØ±Ù‡â€ŒÙ‡Ø§:', error);
                showAlert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯ÙˆØ±Ù‡â€ŒÙ‡Ø§', 'error');
            }
        }

        // Render periods table
        function renderPeriodsTable() {
            const tbody = document.querySelector('#periods-table tbody');
            
            if (periods.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7">Ù‡ÛŒÚ† Ø¯ÙˆØ±Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</td></tr>';
                return;
            }
            
            tbody.innerHTML = periods.map(period => `
                <tr>
                    <td>${period.period_code}</td>
                    <td>${period.period_name}</td>
                    <td>${period.start_date}</td>
                    <td>${period.end_date}</td>
                    <td>${period.total_tours}</td>
                    <td><span class="status-badge status-active">${period.status}</span></td>
                    <td>
                        <button class="btn btn-info" onclick="viewPeriodDetails('${period.period_code}')">
                            Ø¬Ø²Ø¦ÛŒØ§Øª
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Create period form handler
        document.getElementById('period-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                period_name: document.getElementById('period-name').value,
                start_date: document.getElementById('start-date').value,
                end_date: document.getElementById('end-date').value,
                total_tours: document.getElementById('total-tours').value
            };
            
            try {
                const response = await fetch('/create_visit_period', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert(result.message);
                    document.getElementById('period-form').reset();
                    loadPeriods();
                } else {
                    showAlert(result.error, 'error');
                }
            } catch (error) {
                console.error('Ø®Ø·Ø§:', error);
                showAlert('Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ø¯ÙˆØ±Ù‡', 'error');
            }
        });

        // Load data for tours tab
        async function loadToursData() {
            await loadPeriods();
            await loadBazaryabs();
            await loadTours();
        }

        // Load bazaryabs (sales people)
        async function loadBazaryabs() {
            try {
                const response = await fetch('/get_salespeople_list');
                const data = await response.json();
                
                if (data.salespeople) {
                    bazaryabs = data.salespeople;
                    updateBazaryabSelects();
                }
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¨Ø§Ø²Ø§Ø±ÛŒØ§Ø¨Ø§Ù†:', error);
            }
        }

        // Update period select options
        function updatePeriodSelects() {
            const selects = ['select-period', 'report-period'];
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>' +
                        periods.map(period => 
                            `<option value="${period.period_code}">${period.period_name}</option>`
                        ).join('');
                }
            });
        }

        // Update bazaryab select options
        function updateBazaryabSelects() {
            const selects = ['select-bazaryab', 'report-bazaryab'];
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    const currentFirstOption = select.querySelector('option').outerHTML;
                    select.innerHTML = currentFirstOption +
                        bazaryabs.map(bazaryab => 
                            `<option value="${bazaryab.code}">${bazaryab.name}</option>`
                        ).join('');
                }
            });
        }

        // Load tours
        async function loadTours() {
            try {
                const response = await fetch('/get_visit_tours');
                const data = await response.json();
                
                if (data.tours) {
                    tours = data.tours;
                    renderToursTable();
                    updateTourSelects();
                }
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªÙˆØ±Ù‡Ø§:', error);
            }
        }

        // Render tours table
        function renderToursTable() {
            const tbody = document.querySelector('#tours-table tbody');
            
            if (tours.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8">Ù‡ÛŒÚ† ØªÙˆØ±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</td></tr>';
                return;
            }
            
            tbody.innerHTML = tours.map(tour => `
                <tr>
                    <td>${tour.tour_code}</td>
                    <td>${tour.period_name}</td>
                    <td>ØªÙˆØ± ${tour.tour_number}</td>
                    <td>${tour.tour_date}</td>
                    <td>${tour.bazaryab_name}</td>
                    <td>${tour.customer_count} Ù…Ø´ØªØ±ÛŒ</td>
                    <td><span class="status-badge ${getStatusClass(tour.status)}">${tour.status}</span></td>
                    <td>
                        <button class="btn btn-info" onclick="printTour('${tour.tour_code}')">
                            ğŸ–¨ï¸ Ú†Ø§Ù¾
                        </button>
                        ${tour.status === 'Ú†Ø§Ù¾ Ø´Ø¯Ù‡' ? `
                            <button class="btn btn-success" onclick="markReceived('${tour.tour_code}')">
                                âœ… ØªØ­ÙˆÛŒÙ„
                            </button>
                        ` : ''}
                    </td>
                </tr>
            `).join('');
        }

        function getStatusClass(status) {
            switch (status) {
                case 'ØªØ¹Ø±ÛŒÙ Ø´Ø¯Ù‡': return 'status-active';
                case 'Ú†Ø§Ù¾ Ø´Ø¯Ù‡': return 'status-printed';
                case 'ØªØ­ÙˆÛŒÙ„ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡': return 'status-completed';
                default: return 'status-active';
            }
        }

        // Create tours form handler
        document.getElementById('tours-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                period_code: document.getElementById('select-period').value,
                bazaryab_code: document.getElementById('select-bazaryab').value
            };
            
            try {
                const response = await fetch('/create_tours_for_period', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert(result.message);
                    loadTours();
                } else {
                    showAlert(result.error, 'error');
                }
            } catch (error) {
                console.error('Ø®Ø·Ø§:', error);
                showAlert('Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ ØªÙˆØ±Ù‡Ø§', 'error');
            }
        });

        // Print tour
        function printTour(tourCode) {
            window.open(`/print_tour_list/${tourCode}`, '_blank');
        }

        // Mark tour as received
        async function markReceived(tourCode) {
            if (!confirm('Ø¢ÛŒØ§ Ø§ÛŒÙ† ØªÙˆØ± Ø¨Ù‡ Ø¨Ø§Ø²Ø§Ø±ÛŒØ§Ø¨ ØªØ­ÙˆÛŒÙ„ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯ØŸ')) return;
            
            try {
                const response = await fetch('/mark_tour_received', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ tour_code: tourCode })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert(result.message);
                    loadTours();
                } else {
                    showAlert(result.error, 'error');
                }
            } catch (error) {
                console.error('Ø®Ø·Ø§:', error);
                showAlert('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª ØªØ­ÙˆÛŒÙ„', 'error');
            }
        }

        // Load execution data
        async function loadExecutionData() {
            await loadTours();
            
            // Populate tour select for execution
            const execTourSelect = document.getElementById('exec-tour');
            execTourSelect.innerHTML = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>' +
                tours.filter(t => t.status === 'ØªØ­ÙˆÛŒÙ„ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡' || t.status === 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§')
                     .map(tour => `<option value="${tour.tour_code}">${tour.tour_code} - ${tour.period_name}</option>`)
                     .join('');
        }

        // Handle tour selection for execution
        document.getElementById('exec-tour').addEventListener('change', async (e) => {
            const tourCode = e.target.value;
            
            if (!tourCode) {
                document.getElementById('tour-customers').style.display = 'none';
                return;
            }
            
            try {
                const response = await fetch(`/get_tour_customers/${tourCode}`);
                const data = await response.json();
                
                if (data.success) {
                    renderCustomersChecklist(data);
                    document.getElementById('tour-customers').style.display = 'block';
                } else {
                    showAlert(data.error, 'error');
                }
            } catch (error) {
                console.error('Ø®Ø·Ø§:', error);
                showAlert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø´ØªØ±ÛŒØ§Ù†', 'error');
            }
        });

        // Render customers checklist
        function renderCustomersChecklist(data) {
            const container = document.getElementById('customers-checklist');
            const customers = data.customers;
            const visitedCustomers = data.visited_customers;
            
            container.innerHTML = customers.map(customer => `
                <div style="display: flex; align-items: center; padding: 10px; border: 1px solid #e1e1e1; margin-bottom: 5px; border-radius: 5px;">
                    <input type="checkbox" 
                           id="customer-${customer.customer_code}" 
                           value="${customer.customer_code}"
                           ${visitedCustomers.includes(customer.customer_code) ? 'checked' : ''}
                           style="margin-left: 10px;">
                    <label for="customer-${customer.customer_code}">
                        ${customer.customer_name} (${customer.customer_code})
                    </label>
                </div>
            `).join('');
        }

        // Save execution
        document.getElementById('save-execution').addEventListener('click', async () => {
            const tourCode = document.getElementById('exec-tour').value;
            const checkboxes = document.querySelectorAll('#customers-checklist input[type="checkbox"]:checked');
            const visitedCustomers = Array.from(checkboxes).map(cb => cb.value);
            
            if (!tourCode) {
                showAlert('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ØªÙˆØ± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯', 'error');
                return;
            }
            
            try {
                const response = await fetch('/submit_tour_execution', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tour_code: tourCode,
                        visited_customers: visitedCustomers
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert(result.message);
                    document.getElementById('exec-tour').value = '';
                    document.getElementById('tour-customers').style.display = 'none';
                } else {
                    showAlert(result.error, 'error');
                }
            } catch (error) {
                console.error('Ø®Ø·Ø§:', error);
                showAlert('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª ÙˆÛŒØ²ÛŒØªâ€ŒÙ‡Ø§', 'error');
            }
        });

        // Load reports data
        async function loadReportsData() {
            await loadPeriods();
            await loadBazaryabs();
            
            updatePeriodSelects();
            updateBazaryabSelects();
        }

        // Generate report
        async function generateReport() {
            const periodCode = document.getElementById('report-period').value;
            const bazaryabCode = document.getElementById('report-bazaryab').value;
            
            if (!periodCode) {
                showAlert('Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ±Ù‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯', 'error');
                return;
            }
            
            try {
                const response = await fetch('/get_visit_report', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        period_code: periodCode,
                        bazaryab_code: bazaryabCode
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    renderReport(data);
                    document.getElementById('report-results').style.display = 'block';
                } else {
                    showAlert(data.error, 'error');
                }
            } catch (error) {
                console.error('Ø®Ø·Ø§:', error);
                showAlert('Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ Ú¯Ø²Ø§Ø±Ø´', 'error');
            }
        }

        // Render report
        function renderReport(data) {
            const container = document.getElementById('report-content');
            const summary = data.summary;
            const reportData = data.report_data;
            
            let html = `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h4>${data.period_info.period_name}</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 15px;">
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #667eea;">${summary.total_tours}</div>
                            <div style="color: #666;">Ú©Ù„ ØªÙˆØ±Ù‡Ø§</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #28a745;">${summary.total_customers}</div>
                            <div style="color: #666;">Ú©Ù„ Ù…Ø´ØªØ±ÛŒØ§Ù†</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #17a2b8;">${summary.visited_customers}</div>
                            <div style="color: #666;">ÙˆÛŒØ²ÛŒØª Ø´Ø¯Ù‡</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #ffc107;">${summary.visit_percentage}%</div>
                            <div style="color: #666;">Ø¯Ø±ØµØ¯ ÙˆÛŒØ²ÛŒØª</div>
                        </div>
                    </div>
                </div>
            `;
            
            if (reportData.length > 0) {
                html += '<h4>Ø¬Ø²Ø¦ÛŒØ§Øª ØªÙˆØ±Ù‡Ø§:</h4>';
                
                reportData.forEach(tour => {
                    html += `
                        <div style="border: 1px solid #e1e1e1; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h5>${tour.tour_code} - ${tour.bazaryab_name}</h5>
                                <span style="padding: 5px 10px; background: ${tour.visit_percentage >= 80 ? '#d4edda' : tour.visit_percentage >= 50 ? '#fff3cd' : '#f8d7da'}; border-radius: 15px; font-size: 12px;">
                                    ${tour.visited_customers}/${tour.total_customers} (${tour.visit_percentage}%)
                                </span>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">
                                ${tour.customers.map(customer => `
                                    <div style="display: flex; align-items: center; padding: 5px;">
                                        <span style="margin-left: 10px; color: ${customer.visited ? '#28a745' : '#dc3545'};">
                                            ${customer.visited ? 'âœ…' : 'âŒ'}
                                        </span>
                                        <span style="font-size: 14px;">
                                            ${customer.customer_name}
                                        </span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                });
            }
            
            container.innerHTML = html;
        }

        // Update tour selects
        function updateTourSelects() {
            // This function can be expanded if needed
        }

        // Load initial data when page loads
        document.addEventListener('DOMContentLoaded', () => {
            loadPeriods();
        });
    </script>
</body>
</html>